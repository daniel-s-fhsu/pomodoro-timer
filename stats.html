<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pomodoro Timer - Stats</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#d32f2f" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Pomodoro" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />

  <link rel="stylesheet" href="assets/css/materialize.min.css" />
  <link rel="stylesheet" href="assets/css/app.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
</head>

<body>
  <nav class="nav navbar">
    <div class="nav-wrapper">
      <a href="#!" class="brand-logo">Stats</a>
      <a href="#" data-target="mobile" class="sidenav-trigger"><i class="material-icons">menu</i></a>
      <ul class="right hide-on-med-and-down">
        <li><a href="index.html">Timer</a></li>
        <li><a href="stats.html">Statistics</a></li>
        <li><a href="#" class="btn-switch-theme"><i class="material-icons">dark_mode</i></a></li>
        <li class="nav-user-email" style="display:none;"><span data-auth-email></span></li>
        <li style="display:none;"><a href="#" data-auth-logout-link>Logout</a></li>
        <li><a href="login.html" data-auth-login-link>Login</a></li>
      </ul>
    </div>
  </nav>

  <ul class="sidenav" id="mobile">
    <li><a href="index.html">Timer</a></li>
    <li><a href="stats.html">Statistics</a></li>
    <li><a href="#" class="btn-switch-theme sidenav-close"><span>Dark Mode Toggle</span></a></li>
    <li class="nav-user-email" style="display:none;"><span data-auth-email></span></li>
    <li style="display:none;"><a href="#" class="sidenav-close" data-auth-logout-link>Logout</a></li>
    <li><a href="login.html" class="sidenav-close" data-auth-login-link>Login</a></li>
  </ul>

  <div id="stats-div" class="container">
    <h5 class="center-align">Focus Sessions</h5>

    <div id="stats-auth-message" class="card-panel red lighten-5" style="display: none;">
      <span>Please log in to view your statistics.</span>
    </div>

    <div id="stats-content" style="display: none;">
      <table class="striped centered">
        <thead>
          <tr>
            <th>Date</th>
            <th>Subject (click to change)</th>
            <th>Duration</th>
          </tr>
        </thead>
        <tbody id="sessions-body">
          <tr><td colspan="3">No sessions found.</td></tr>
        </tbody>
      </table>

      <div id="edit-form-wrapper" class="card-panel" style="display: none; margin-top: 2rem;">
        <form id="subject-edit-form">
          <input type="hidden" id="edit-stat-id">
          <div class="input-field">
            <input id="edit-subject" type="text" maxlength="40" required />
            <label for="edit-subject">Edit subject</label>
          </div>
          <div class="right-align">
            <button type="submit" class="btn red">Save</button>
            <button type="button" id="cancel-edit" class="btn-flat">Cancel</button>
          </div>
        </form>
      </div>

      <div class="right-align" style="margin-top: 1em;">
        <a id="clear-stats" class="btn-flat disabled"><i class="material-icons left">delete</i>Clear</a>
      </div>
    </div>
  </div>

  <script src="assets/javascript/materialize.min.js"></script>
  <script src="assets/javascript/ui.js"></script>
  <script src="assets/javascript/dark-mode.js"></script>
  <script type="module" src="./assets/javascript/auth-ui.js"></script>

  <script type="module">
    import { loadStatBlocks, deleteStatBlock, updateStatBlock } from "./assets/javascript/db-implementation.js";
    import { onAuthChange } from "./assets/javascript/firebaseDB.js";

    const tbody = document.getElementById('sessions-body');
    const clearBtn = document.getElementById('clear-stats');
    const editWrapper = document.getElementById('edit-form-wrapper');
    const editForm = document.getElementById('subject-edit-form');
    const editSubjectInput = document.getElementById('edit-subject');
    const editStatIdInput = document.getElementById('edit-stat-id');
    const cancelEditBtn = document.getElementById('cancel-edit');
    const authMessageBox = document.getElementById('stats-auth-message');
    const statsContent = document.getElementById('stats-content');

    let currentStats = [];
    let activeUser = null;

    function renderSessions() {
      tbody.innerHTML = '';

      if (!currentStats.length) {
        const emptyRow = document.createElement('tr');
        const emptyCell = document.createElement('td');
        emptyCell.colSpan = 3;
        emptyCell.textContent = 'No sessions found.';
        emptyRow.appendChild(emptyCell);
        tbody.appendChild(emptyRow);
        return;
      }

      currentStats.forEach((s) => {
        const tr = document.createElement('tr');
        const dateTd = document.createElement('td');
        dateTd.textContent = s.date ? new Date(s.date).toLocaleString() : 'Unknown';

        const subjectTd = document.createElement('td');
        subjectTd.classList.add('subject-cell');
        subjectTd.dataset.id = String(s.id);
        subjectTd.textContent = s.subject || 'Unlabeled';

        const durationTd = document.createElement('td');
        durationTd.textContent = `${s.minutes ?? 0} min`;

        tr.append(dateTd, subjectTd, durationTd);
        tbody.appendChild(tr);
      });
    }

    async function refreshSessions() {
      if (!activeUser) {
        currentStats = [];
        renderSessions();
        return;
      }
      try {
        currentStats = await loadStatBlocks();
        currentStats.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
      } catch (err) {
        console.error('Unable to load stats:', err);
        currentStats = [];
      }
      renderSessions();
    }

    function showEditForm(stat) {
      editStatIdInput.value = String(stat.id);
      editSubjectInput.value = stat.subject || 'Unlabeled';
      editWrapper.style.display = 'block';
      if (window.M && M.updateTextFields) {
        M.updateTextFields();
      }
    }

    function hideEditForm() {
      editStatIdInput.value = '';
      editSubjectInput.value = '';
      editWrapper.style.display = 'none';
    }

    tbody.addEventListener('click', (event) => {
      const subjectCell = event.target.closest('.subject-cell');
      if (!subjectCell) return;

      const statId = subjectCell.dataset.id;
      const stat = currentStats.find((s) => String(s.id) === statId);
      if (stat) {
        showEditForm(stat);
      }
    });

    editForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const statId = editStatIdInput.value;
      const newSubject = editSubjectInput.value.trim() || 'Unlabeled';
      if (!statId) return;

      const stat = currentStats.find((s) => String(s.id) === statId);
      if (!stat) return;

      const updatedData = { ...stat, subject: newSubject };

      try {
        await updateStatBlock(stat.id, updatedData);
        if (window.M && M.toast) M.toast({ html: 'Subject updated' });
      } catch (err) {
        console.error('Failed to update subject:', err);
      } finally {
        hideEditForm();
        await refreshSessions();
      }
    });

    cancelEditBtn.addEventListener('click', (event) => {
      event.preventDefault();
      hideEditForm();
    });

    clearBtn.addEventListener('click', async (event) => {
      event.preventDefault();
      if (!activeUser || clearBtn.classList.contains('disabled')) return;
      if (!confirm('Clear all saved sessions?')) return;

      try {
        await Promise.all(currentStats.map((stat) => deleteStatBlock(stat.id)));
        if (window.M && M.toast) M.toast({ html: 'Sessions cleared' });
      } catch (err) {
        console.error('Unable to clear stats:', err);
      } finally {
        hideEditForm();
        await refreshSessions();
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      if (window.M && M.Sidenav) M.Sidenav.init(document.querySelectorAll('.sidenav'));
    });

    function setAuthUi(user) {
      activeUser = user;
      const isAuthed = Boolean(user);
      if (statsContent) statsContent.style.display = isAuthed ? 'block' : 'none';
      if (authMessageBox) authMessageBox.style.display = isAuthed ? 'none' : 'block';
      if (clearBtn) clearBtn.classList.toggle('disabled', !isAuthed);
      if (!isAuthed) {
        hideEditForm();
        currentStats = [];
        renderSessions();
      } else {
        refreshSessions();
      }
    }

    onAuthChange((user) => {
      setAuthUi(user);
    });
  </script>
</body>
</html>
